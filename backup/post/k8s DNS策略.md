---
title: "K8s DNS策略"
tags: ["Kubernetes"]
categories: ["Kubernetes"]
date: 2021-06-04T20:49:48+08:00
toc: true
draft: false
---

k8s内设了4中DNS配置策略，通过dnsPolicy可配置
* None : 无任何策略
* Default ：默认
* ClusterFirst ：集群 DNS 优先
* ClusterFirstWithHostNet ：集群DNS优先，同时也使用宿主机网络

## 1、None策略
当dnsPolicy设置成None后，k8s不会为pod加载任何DNS配置。为了避免Pod里面没有DNS配置，最后通过dnsConfig来自定义DNS参数，如下所示：
```
apiVersion: v1
kind: Pod
metadata:
  name: demo
  namespace: default
spec:
  containers:
  - image: base/java
    command:
      - "java -jar /opt/app.jar"
    imagePullPolicy: IfNotPresent
    name: demo
  restartPolicy: Always
  dnsPolicy: None
  dnsConfig:
    nameservers:
      - xxx.xxx.xxx.xxx
    searches:
      - ns1.svc.cluster.local
      - my.dns.search.suffix
    options:
      - name: ndots
        value: "2"
      - name: edns0
```
通过上述配置创建 Pod 之后，执行 `kubectl exec demo cat /etc/resolv.conf` 命令即可看到自定义的配置项目，如下：
```
# kubectl exec demo cat /etc/resolv.conf
nameserver xxx.xxx.xxx.xxx
search ns1.svc.cluster.local my.dns.search.suffix
options ndots:2 edns0
```


## 2、Default策略
Pod里面的DNS配置继承了宿主机上的DNS配置。
```
apiVersion: v1
kind: Pod
metadata:
  name: demo
  namespace: default
spec:
  containers:
  - image: base/java
    command:
      - "java -jar /opt/app.jar"
    imagePullPolicy: IfNotPresent
    name: demo
  restartPolicy: Always
  dnsPolicy: Default          # 配置DNS策略
```

查看宿主机的DNS配置
```
# cat /etc/resolv.conf 
options timeout:2 attempts:3 rotate single-request-reopen
; generated by /usr/sbin/dhclient-script
nameserver 100.100.2.136
nameserver 100.100.2.138
```

通过上述配置创建 Pod 之后，如下：
```
# kubectl exec demo cat /etc/resolv.conf
nameserver 100.100.2.136
nameserver 100.100.2.138
options timeout:2 attempts:3 rotate single-request-reopen
```
可以看到，dnsPolicy设置成Default后，Pod里的DNS使用了宿主机的DNS配置

## 3、ClusterFirst策略
与 Default 相反，会使用k8s集群里的kube-dns(CoreDNS) 的信息当预设参数写入到该 Pod 内的DNS配置。

## 4、ClusterFirstWithHostNet策略
集群DNS优先，同时也使用宿主机网络。
